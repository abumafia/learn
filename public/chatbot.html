<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot - EnglishMaster</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-9TPMYRZJLX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-9TPMYRZJLX');
</script>
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-family: 'Inter', sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .card-hover { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1); }
        .btn-glow { box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); transition: all 0.3s ease; }
        .btn-glow:hover { box-shadow: 0 8px 25px rgba(59, 130, 246, 0.6); transform: scale(1.02); }
        .message-bubble { animation: messageSlide 0.3s ease-out; }
        @keyframes messageSlide { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .typing-indicator { animation: typing 1.5s infinite; }
        @keyframes typing { 0%, 100% { opacity: 0.4; } 50% { opacity: 1; } }
        .fade-in { animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .modal-enter { animation: modalEnter 0.4s ease-out; }
        @keyframes modalEnter { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .sidebar { transition: transform 0.3s ease-in-out; }
        .sidebar.hidden { transform: translateX(-100%); }
        @media (max-width: 768px) {
            .sidebar { position: fixed; top: 0; left: 0; height: 100vh; z-index: 40; }
            .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 30; }
        }
    </style>
</head>
<body class="min-h-screen text-white">
    <!-- Mobile Overlay -->
    <div id="mobileOverlay" class="overlay hidden" onclick="closeMobileMenu()"></div>

    <!-- Navigation -->
    <nav class="glass fixed top-0 w-full z-50 py-3 px-4 lg:px-6 shadow-2xl">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <button onclick="openMobileMenu()" class="lg:hidden text-white p-2 rounded-lg hover:bg-white/10">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <a href="/courses" class="text-lg font-bold flex items-center text-white hover:text-blue-200 glass px-3 py-1.5 rounded-xl transition text-sm lg:text-base">
                    <i class="fas fa-arrow-left mr-1 lg:mr-2"></i> Kurslarga qaytish
                </a>
            </div>
            <div class="hidden lg:flex items-center space-x-3">
                <span id="userCoins" class="glass px-3 py-1.5 rounded-full font-semibold flex items-center text-sm">
                    <i class="fas fa-coins mr-1 text-yellow-400"></i> <span id="coinsCount">0</span> coin
                </span>
                <button onclick="openWritingAssistant()" class="btn-glow bg-purple-600 hover:bg-purple-700 px-3 py-1.5 rounded-xl flex items-center text-white text-sm">
                    <i class="fas fa-robot mr-1"></i> AI Writing
                </button>
                <a href="/profile" class="glass px-3 py-1.5 rounded-xl hover:bg-white/10 text-white transition text-sm">Profil</a>
                <button onclick="logout()" class="btn-glow bg-red-600 hover:bg-red-700 px-3 py-1.5 rounded-xl text-white text-sm">Chiqish</button>
            </div>
            <!-- Mobile Menu Button -->
            <button onclick="openMobileMenu()" class="lg:hidden text-white p-2 rounded-lg hover:bg-white/10">
                <i class="fas fa-user-circle text-xl"></i>
            </button>
        </div>
    </nav>

    <!-- Mobile Sidebar Menu -->
    <div id="mobileMenu" class="sidebar lg:hidden glass w-56 p-4 hidden">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-lg font-bold">Menyu</h2>
            <button onclick="closeMobileMenu()" class="text-gray-300 hover:text-white">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <ul class="space-y-3">
            <li><a href="/courses" class="block py-2 px-3 rounded-lg hover:bg-white/10 transition text-sm">Kurslar</a></li>
            <li><span id="mobileCoins" class="block py-2 px-3 rounded-lg bg-white/10 font-semibold flex items-center text-sm">
                <i class="fas fa-coins mr-1 text-yellow-400"></i> <span id="mobileCoinsCount">0</span> coin
            </span></li>
            <li><button onclick="openWritingAssistant()" class="w-full text-left py-2 px-3 rounded-lg hover:bg-white/10 transition flex items-center text-sm">
                <i class="fas fa-robot mr-1"></i> AI Writing
            </button></li>
            <li><a href="/profile" class="block py-2 px-3 rounded-lg hover:bg-white/10 transition text-sm">Profil</a></li>
            <li><button onclick="logout()" class="w-full text-left py-2 px-3 rounded-lg hover:bg-red-500/20 transition flex items-center text-sm">
                <i class="fas fa-sign-out-alt mr-1"></i> Chiqish
            </button></li>
        </ul>
    </div>

    <div class="pt-16 container mx-auto px-3 py-6 lg:py-8">
        <!-- Chatbot Header -->
        <div class="glass rounded-2xl p-4 lg:p-6 mb-6 fade-in text-center">
            <div class="flex items-center justify-center space-x-3 mb-3">
                <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                    <i class="fas fa-robot text-white text-xl"></i>
                </div>
                <h1 class="text-xl lg:text-2xl font-bold text-white">EnglishMaster Chatbot</h1>
            </div>
            <p class="text-gray-300 text-sm lg:text-base">Sizning ingliz tili o'rganish yordamchingiz. Savollaringizni bering yoki progressni ko'ring!</p>
        </div>

        <!-- Chat Container -->
        <div class="glass rounded-2xl h-96 lg:h-[500px] flex flex-col overflow-hidden mb-6 fade-in">
            <!-- Messages Area -->
            <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-3 lg:space-y-4 scrollbar-thin scrollbar-thumb-white/20 scrollbar-track-transparent">
                <!-- Bot welcome message -->
                <div class="message-bubble max-w-[80%] lg:max-w-[70%] bg-blue-500/20 border border-blue-500/30 rounded-2xl p-3 lg:p-4 ml-auto">
                    <div class="flex items-start space-x-2">
                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-robot text-white text-sm"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-white text-sm lg:text-base">Salom! Men EnglishMaster chatbotman. Sizning progressni tahlil qilib, mos kurslarni tavsiya qila olaman. Nima haqida gaplashamiz? Masalan: "Mening progressim qanday?" yoki "Boshlang'ich daraja kurslarini tavsiya qiling."</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Typing Indicator -->
            <div id="typingIndicator" class="hidden p-4">
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-robot text-white text-sm"></i>
                    </div>
                    <div class="flex space-x-1">
                        <div class="w-2 h-2 bg-gray-400 rounded-full typing-indicator"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full typing-indicator" style="animation-delay: 0.2s;"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full typing-indicator" style="animation-delay: 0.4s;"></div>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-3 lg:p-4 border-t border-white/20 bg-white/5">
                <div class="flex space-x-2">
                    <input type="text" id="messageInput" placeholder="Xabaringizni yozing..." 
                           class="flex-1 bg-white/10 border border-white/20 rounded-xl px-3 py-2 lg:px-4 lg:py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm lg:text-base">
                    <button onclick="sendMessage()" class="btn-glow bg-gradient-to-r from-blue-500 to-purple-600 text-white p-2 lg:p-3 rounded-xl hover:scale-105">
                        <i class="fas fa-paper-plane text-sm lg:text-base"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Quick Suggestions -->
        <div class="glass rounded-2xl p-4 lg:p-6 fade-in">
            <h3 class="text-lg font-bold mb-3 text-white">Tez savollar:</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-2">
                <button onclick="quickMessage('Mening progressim qanday?')" class="glass p-2 lg:p-3 rounded-xl hover:bg-white/20 transition text-xs lg:text-sm text-center">Progressim</button>
                <button onclick="quickMessage('Menga kurs tavsiya qiling')" class="glass p-2 lg:p-3 rounded-xl hover:bg-white/20 transition text-xs lg:text-sm text-center">Kurs tavsiya</button>
                <button onclick="quickMessage('Grammatika maslahatlari')" class="glass p-2 lg:p-3 rounded-xl hover:bg-white/20 transition text-xs lg:text-sm text-center">Grammatika</button>
                <button onclick="quickMessage('So\'z boyligimni oshirish')" class="glass p-2 lg:p-3 rounded-xl hover:bg-white/20 transition text-xs lg:text-sm text-center">So'z boyligi</button>
            </div>
        </div>
    </div>

    <!-- Writing Assistant Modal (Global) -->
    <div id="writingModal" class="fixed inset-0 bg-black bg-opacity-80 hidden flex items-center justify-center z-50 p-2 lg:p-4 modal-enter">
        <div class="glass rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="p-3 lg:p-4 border-b border-white/20 flex justify-between items-center">
                <h3 class="text-base lg:text-xl font-bold text-white">AI Yozuv Yordamchisi</h3>
                <button onclick="closeWritingModal()" class="text-gray-300 hover:text-white">
                    <i class="fas fa-times text-lg lg:text-xl"></i>
                </button>
            </div>
            <div class="p-3 lg:p-4">
                <textarea id="writingText" rows="6" 
                          class="w-full p-3 lg:p-4 bg-white/10 border border-white/20 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-purple-400 mb-3 lg:mb-4 text-sm lg:text-base"
                          placeholder="Ingliz tilida matn yozing..."></textarea>
                <button onclick="checkWriting()" class="btn-glow bg-gradient-to-r from-purple-500 to-purple-600 text-white px-5 lg:px-6 py-2 lg:py-3 rounded-xl font-semibold w-full mb-3 lg:mb-4 text-sm">Tekshirish</button>
                <div id="writingResult" class="hidden space-y-3 lg:space-y-4">
                    <div class="glass p-3 lg:p-4 rounded-xl">
                        <h4 class="text-lg lg:text-xl font-bold mb-2 text-white">Baholash: <span id="writingScore" class="text-blue-400">0/10</span></h4>
                        <p id="writingFeedback" class="text-gray-300 text-sm lg:text-base"></p>
                    </div>
                    <div id="grammarMistakes" class="space-y-2"></div>
                    <div id="suggestions" class="space-y-2"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = '/login';
        let userId = null;
        let messages = [];
        let recognition = null;
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const profileRes = await fetch('https://learn-prc7.onrender.com/api/profile', { headers: { 'Authorization': `Bearer ${token}` } });
                if (profileRes.ok) {
                    const user = await profileRes.json();
                    userId = user._id;
                    loadUserCoins();
                }
                // Initial bot message already in HTML
            } catch (err) {
                console.error('Init error:', err);
            }
        });

        async function loadUserCoins() {
            try {
                const res = await fetch('https://learn-prc7.onrender.com/api/profile', { headers: { 'Authorization': `Bearer ${token}` } });
                if (res.ok) {
                    const user = await res.json();
                    document.getElementById('coinsCount').textContent = user.coins;
                    document.getElementById('mobileCoinsCount').textContent = user.coins;
                }
            } catch (err) {
                console.error('Coins load error:', err);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;

            // User message
            addMessage(message, 'user');
            input.value = '';

            // Show typing
            showTyping(true);

            try {
                const res = await fetch('https://learn-prc7.onrender.com/api/chatbot/message', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message, userId })
                });
                const data = await res.json();
                if (res.ok) {
                    addMessage(data.response, 'bot');
                } else {
                    addMessage('Kechirasiz, xato yuz berdi. Qayta urinib ko\'ring.', 'bot');
                }
            } catch (err) {
                addMessage('Ulanish xatosi. Internetni tekshiring.', 'bot');
            } finally {
                showTyping(false);
            }
        }

        function addMessage(text, sender) {
            const messagesDiv = document.getElementById('chatMessages');
            const bubble = document.createElement('div');
            bubble.className = `message-bubble max-w-[80%] lg:max-w-[70%] rounded-2xl p-3 lg:p-4 ${sender === 'user' ? 'bg-purple-500/20 border border-purple-500/30 ml-auto' : 'bg-blue-500/20 border border-blue-500/30 mr-auto'}`;
            bubble.innerHTML = `
                <div class="flex items-start space-x-2 ${sender === 'user' ? 'flex-row-reverse space-x-reverse' : ''}">
                    <div class="w-8 h-8 ${sender === 'user' ? 'bg-purple-500' : 'bg-blue-500'} rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fas ${sender === 'user' ? 'fa-user' : 'fa-robot'} text-white text-sm"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-white text-sm lg:text-base">${text}</p>
                    </div>
                </div>
            `;
            messagesDiv.appendChild(bubble);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function showTyping(show) {
            document.getElementById('typingIndicator').classList.toggle('hidden', !show);
            const messagesDiv = document.getElementById('chatMessages');
            if (show) {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        }

        function quickMessage(text) {
            document.getElementById('messageInput').value = text;
            sendMessage();
        }

        // Enter key for send
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // Writing Assistant (from previous)
        function openWritingAssistant() {
            document.getElementById('writingModal').classList.remove('hidden');
        }
        function closeWritingModal() {
            document.getElementById('writingModal').classList.add('hidden');
            document.getElementById('writingResult').classList.add('hidden');
        }
        async function checkWriting() {
            const text = document.getElementById('writingText').value.trim();
            if (!text) return alert('Matn kiriting');
            try {
                const res = await fetch('https://learn-prc7.onrender.com/api/ai/writing-check', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ text })
                });
                const result = await res.json();
                document.getElementById('writingScore').textContent = `${result.score}/10`;
                document.getElementById('writingFeedback').textContent = result.overallFeedback;
                const mistakesDiv = document.getElementById('grammarMistakes');
                mistakesDiv.innerHTML = result.grammarMistakes.map(m => `
                    <div class="glass p-2 lg:p-3 rounded-xl border-l-4 border-red-400 bg-red-500/10">
                        <p class="text-white text-xs lg:text-sm"><strong>Xato:</strong> ${m.mistake} â†’ <strong>To'g'ri:</strong> ${m.correction}</p>
                        <p class="text-red-300 text-xs">${m.explanation}</p>
                    </div>
                `).join('') || '<p class="text-green-400 font-medium text-sm">Xato topilmadi!</p>';
                const suggestionsDiv = document.getElementById('suggestions');
                suggestionsDiv.innerHTML = result.suggestions.map(s => `
                    <div class="glass p-2 lg:p-3 rounded-xl border-l-4 border-blue-400 bg-blue-500/10">
                        <p class="text-white text-xs lg:text-sm">${s}</p>
                    </div>
                `).join('') || '<p class="text-gray-400 text-sm">Qo\'shimcha takliflar yo\'q</p>';
                document.getElementById('writingResult').classList.remove('hidden');
            } catch (err) {
                alert('Tekshirishda xato');
            }
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/';
        }
        function openMobileMenu() {
            document.getElementById('mobileMenu').classList.remove('hidden');
            document.getElementById('mobileOverlay').classList.remove('hidden');
        }
        function closeMobileMenu() {
            document.getElementById('mobileMenu').classList.add('hidden');
            document.getElementById('mobileOverlay').classList.add('hidden');
        }
    </script>
</body>
</html>

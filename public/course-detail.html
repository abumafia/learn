<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kurs - EnglishMaster</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <a href="/" class="text-2xl font-bold flex items-center">
                    <i class="fas fa-graduation-cap mr-2"></i>
                    EnglishMaster
                </a>
                <div class="flex items-center space-x-6">
                    <a href="/courses" class="hover:text-blue-200 transition">Kurslar</a>
                    <div id="authButtons" class="flex items-center space-x-4">
                        <a href="/login" class="hover:text-blue-200 transition">Kirish</a>
                        <a href="/register" class="bg-white text-blue-600 px-4 py-2 rounded-lg hover:bg-gray-100 transition">
                            Ro'yxatdan o'tish
                        </a>
                    </div>
                    <div id="userMenu" class="hidden flex items-center space-x-4">
                        <a href="/" class="hover:text-blue-200 transition">Bosh Sahifa</a>
                        <a href="/profile" class="hover:text-blue-200 transition">Profil</a>
                        <a href="/teacher" class="hover:text-blue-200 transition">O'qituvchi</a>
                        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg transition">
                            Chiqish
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Course Header -->
    <div class="bg-white shadow">
        <div class="container mx-auto px-4 py-8">
            <div class="flex flex-col lg:flex-row lg:items-start lg:space-x-8">
                <!-- Course Image -->
                <div class="lg:w-1/3 mb-6 lg:mb-0">
                    <div class="bg-gradient-to-r from-blue-400 to-blue-600 rounded-lg h-64 flex items-center justify-center">
                        <div id="courseImage">
                            <!-- Kurs rasmi yoki ikonka -->
                        </div>
                    </div>
                </div>
                
                <!-- Course Info -->
                <div class="lg:w-2/3">
                    <h1 id="courseTitle" class="text-3xl font-bold text-gray-800 mb-4">Kurs Nomi</h1>
                    <p id="courseDescription" class="text-gray-600 mb-6">Kurs tavsifi</p>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-600" id="lessonsCount">0</div>
                            <div class="text-sm text-gray-600">Darslar</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600" id="studentsCount">0</div>
                            <div class="text-sm text-gray-600">O'quvchilar</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-purple-600" id="courseLevel">-</div>
                            <div class="text-sm text-gray-600">Daraja</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-orange-600" id="coursePrice">0</div>
                            <div class="text-sm text-gray-600">Narx</div>
                        </div>
                    </div>
                    
                    <!-- Teacher Info -->
                    <div class="flex items-center mb-6 p-4 bg-gray-50 rounded-lg">
                        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mr-4">
                            <span class="text-blue-600 font-semibold" id="teacherInitials">AD</span>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-800" id="teacherName">O'qituvchi</h4>
                            <p class="text-gray-600 text-sm" id="teacherBio">O'qituvchi haqida</p>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div id="enrollSection">
                        <!-- Yozilish tugmasi -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Course Content -->
    <div class="container mx-auto px-4 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Lessons Sidebar -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-lg p-6 sticky top-4">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">Kurs Darslari</h3>
                    <div id="lessonsList" class="space-y-2">
                        <!-- Darslar ro'yxati -->
                    </div>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">Kurs Haqida</h3>
                    <div id="courseContent">
                        <!-- Kurs kontenti -->
                    </div>
                    
                    <!-- What You'll Learn -->
                    <div class="mt-8">
                        <h4 class="text-lg font-semibold mb-4 text-gray-800">Nimalarni O'rganasiz?</h4>
                        <div id="learningPoints" class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            <!-- O'rganish punktlari -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Auth holatini tekshirish
        function checkAuth() {
            const token = localStorage.getItem('token');
            const authButtons = document.getElementById('authButtons');
            const userMenu = document.getElementById('userMenu');
            
            if (token) {
                authButtons.classList.add('hidden');
                userMenu.classList.remove('hidden');
            } else {
                authButtons.classList.remove('hidden');
                userMenu.classList.add('hidden');
            }
        }

        // Chiqish funksiyasi
        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/';
        }

        let currentCourse = null;
        let userProgress = null;

        // URL dan kurs ID sini olish
        function getCourseId() {
            const path = window.location.pathname;
            const parts = path.split('/');
            return parts[parts.length - 1];
        }

        // Kurs ma'lumotlarini yuklash
        async function loadCourse() {
            const courseId = getCourseId();
            if (!courseId) {
                window.location.href = '/courses';
                return;
            }

            try {
                const response = await fetch(`/api/courses/${courseId}`);
                if (response.ok) {
                    currentCourse = await response.json();
                    displayCourse();
                    
                    // Agar foydalanuvchi tizimga kirgan bo'lsa, progressni yuklash
                    const token = localStorage.getItem('token');
                    if (token) {
                        await loadUserProgress(courseId);
                    }
                } else {
                    window.location.href = '/courses';
                }
            } catch (error) {
                console.error('Kursni yuklashda xato:', error);
                window.location.href = '/courses';
            }
        }

        function displayCourse() {
            // Asosiy ma'lumotlar
            document.getElementById('courseTitle').textContent = currentCourse.title;
            document.getElementById('courseDescription').textContent = currentCourse.description || 'Tavsif mavjud emas';
            document.getElementById('lessonsCount').textContent = currentCourse.lessons?.length || 0;
            document.getElementById('studentsCount').textContent = currentCourse.students?.length || 0;
            document.getElementById('courseLevel').textContent = getLevelText(currentCourse.level);
            document.getElementById('coursePrice').textContent = currentCourse.price === 0 ? 'Bepul' : currentCourse.price + ' coin';
            
            // O'qituvchi ma'lumotlari
            const teacher = currentCourse.teacher;
            document.getElementById('teacherInitials').textContent = 
                (teacher?.firstName?.charAt(0) || 'A') + (teacher?.lastName?.charAt(0) || 'd');
            document.getElementById('teacherName').textContent = 
                (teacher?.firstName || 'Admin') + ' ' + (teacher?.lastName || '');
            document.getElementById('teacherBio').textContent = teacher?.bio || 'Professional ingliz tili o\'qituvchisi';
            
            // Kurs rasmi
            const courseImage = document.getElementById('courseImage');
            if (currentCourse.image) {
                courseImage.innerHTML = `<img src="/uploads/${currentCourse.image}" alt="${currentCourse.title}" class="w-full h-64 object-cover rounded-lg">`;
            } else {
                courseImage.innerHTML = `<i class="fas fa-book-open text-white text-8xl"></i>`;
            }
            
            // Darslar ro'yxati
            displayLessons();
            
            // Yozilish bo'limi
            displayEnrollSection();
            
            // O'rganish punktlari
            displayLearningPoints();
        }

        function displayLessons() {
            const lessonsList = document.getElementById('lessonsList');
            lessonsList.innerHTML = '';
            
            if (!currentCourse.lessons || currentCourse.lessons.length === 0) {
                lessonsList.innerHTML = '<p class="text-gray-500 text-center">Darslar hali qo\'shilmagan</p>';
                return;
            }
            
            currentCourse.lessons.forEach((lesson, index) => {
                const isCompleted = userProgress?.completedLessons?.includes(lesson._id);
                
                const lessonItem = `
                    <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition duration-200 ${isCompleted ? 'bg-green-50 border-green-200' : ''}">
                        <div class="flex items-center">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center mr-3 ${isCompleted ? 'bg-green-100 text-green-600' : 'bg-blue-100 text-blue-600'}">
                                <i class="fas ${isCompleted ? 'fa-check' : 'fa-play'} text-xs"></i>
                            </div>
                            <div>
                                <h5 class="font-medium text-gray-800">${lesson.title}</h5>
                                <p class="text-sm text-gray-500">${lesson.duration || 0} min</p>
                            </div>
                        </div>
                        ${isCompleted ? '<span class="text-green-600 text-sm"><i class="fas fa-check-circle"></i></span>' : ''}
                    </div>
                `;
                lessonsList.innerHTML += lessonItem;
            });
        }

        function displayEnrollSection() {
            const enrollSection = document.getElementById('enrollSection');
            const token = localStorage.getItem('token');
            
            if (!token) {
                enrollSection.innerHTML = `
                    <div class="space-y-4">
                        <p class="text-gray-600">Kursga yozilish uchun tizimga kiring</p>
                        <div class="flex space-x-4">
                            <a href="/login" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition duration-200">
                                Kirish
                            </a>
                            <a href="/register" class="border border-blue-600 text-blue-600 hover:bg-blue-50 px-6 py-3 rounded-lg font-semibold transition duration-200">
                                Ro'yxatdan o'tish
                            </a>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Foydalanuvchi allaqachon yozilganmi?
            const isEnrolled = currentCourse.students?.some(student => student._id === userProgress?.user);
            
            if (isEnrolled) {
                enrollSection.innerHTML = `
                    <div class="space-y-4">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-600 mr-2"></i>
                                <span class="text-green-800 font-semibold">Siz ushbu kursga yozilgansiz</span>
                            </div>
                            ${userProgress ? `
                                <div class="mt-2">
                                    <div class="flex justify-between text-sm text-green-700 mb-1">
                                        <span>Progress</span>
                                        <span>${userProgress.progress}%</span>
                                    </div>
                                    <div class="w-full bg-green-200 rounded-full h-2">
                                        <div class="bg-green-600 h-2 rounded-full" style="width: ${userProgress.progress}%"></div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        <button onclick="startLearning()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-semibold transition duration-200">
                            O'rganishni Davom Ettirish
                        </button>
                    </div>
                `;
            } else {
                enrollSection.innerHTML = `
                    <div class="space-y-4">
                        <button onclick="enrollCourse()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold transition duration-200">
                            ${currentCourse.price === 0 ? 'Bepul Kursga Yozilish' : `${currentCourse.price} coin evaziga Yozilish`}
                        </button>
                        ${currentCourse.price > 0 ? `
                            <p class="text-sm text-gray-600 text-center">
                                Sizda <span id="userCoins">0</span> coin mavjud
                            </p>
                        ` : ''}
                    </div>
                `;
                
                // Agar pullik kurs bo'lsa, foydalanuvchi coinlarini yuklash
                if (currentCourse.price > 0) {
                    loadUserCoins();
                }
            }
        }

        function displayLearningPoints() {
            const learningPoints = document.getElementById('learningPoints');
            const points = [
                'Grammatika qoidalari',
                'Lug\'at boyitish',
                'Speaking ko\'nikmalari',
                'Listening tushunish',
                'Writing yozish',
                'Reading o\'qish'
            ];
            
            learningPoints.innerHTML = points.map(point => `
                <div class="flex items-center">
                    <i class="fas fa-check text-green-600 mr-2"></i>
                    <span class="text-gray-700">${point}</span>
                </div>
            `).join('');
        }

        async function loadUserProgress(courseId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/progress', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const progressList = await response.json();
                    userProgress = progressList.find(p => p.course._id === courseId);
                }
            } catch (error) {
                console.error('Progress yuklashda xato:', error);
            }
        }

        async function loadUserCoins() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/profile', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('userCoins').textContent = data.user.coins;
                }
            } catch (error) {
                console.error('Coin yuklashda xato:', error);
            }
        }

        async function enrollCourse() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login';
                return;
            }

            try {
                const response = await fetch(`/api/courses/${currentCourse._id}/enroll`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert('Kursga muvaffaqiyatli qo\'shildingiz!');
                    location.reload();
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error('Xato:', error);
                alert('Kursga qo\'shilishda xato yuz berdi');
            }
        }

        function startLearning() {
            if (!currentCourse.lessons || currentCourse.lessons.length === 0) {
                alert('Kursda hali darslar mavjud emas');
                return;
            }
            
            // Birinchi darsni ochish yoki oxirgi boshlangan darsni davom ettirish
            const firstLesson = currentCourse.lessons[0];
            alert(`"${firstLesson.title}" darsini boshlash funksiyasi keyingi versiyada qo'shiladi`);
        }

        function getLevelText(level) {
            const levels = {
                'beginner': 'Boshlang\'ich',
                'elementary': 'Elementar', 
                'intermediate': 'O\'rta',
                'upper-intermediate': 'Yuqori O\'rta',
                'advanced': 'Ilg\'or'
            };
            return levels[level] || level;
        }

        // Sahifa yuklanganda
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadCourse();
        });
    </script>
</body>
</html>